jtreminio.nginx
===============

This role installs and configures nginx. It features sane defaults while allowing
a user to create a highly configured installation.

This role was created from [Vox Pupuli's puppet-nginx](https://github.com/voxpupuli/puppet-nginx)
and most settings closely track that project's.

Requirements
------------

`jtreminio.common` for some Python modules and firewall management, if wanted.

Install
-------

requirements.yml:

```yaml
- name: jtreminio.nginx
  src: https://github.com/jtreminio/ansible-nginx
```

Usage
-----

Sane defaults come included, but everything is configurable.

All settings are controlled by a single dict `_nginx_user_settings`:

```yaml
- set_fact:
    _nginx_user_settings:
      conf:
        error_log_severity: error
        pid: /var/run/nginx.pid
        events:
          worker_connections: 512
          use: epoll
          multi_accept: 'on'
        http:
          gzip: 'on'
          gzip_disable: msie6

- include_role:
    name: jtreminio.nginx
```

Variables
---------

If set to `~` (`null`) or `false`, most variables will not be used.

For example, to not configure the `daemon` value:

```yaml
_nginx_user_settings:
  conf:
    daemon: ~
```

Some variables require a specific value to be used, usually `'on'`. For example:

```yaml
_nginx_user_settings:
  conf:
    events:
      multi_accept: 'on'
    http:
      gzip: 'on'
      sendfile: 'on'
      tcp_nodelay: 'on'
```

Please note that due to stupid design decisions by YAML, you must ensure `on` is surrounded by
single quotes, `'on'`, else YAML silently turns the value into boolean `true`.

The same is true of `off` turning into boolean `false` and requiring `'off'`.

Settings
========

Please look in `defaults/main.yml` for all available options.```

Do _not_ add `;` after any option. These are added automatically.

Unless otherwise noted, all sections have `_prepend` and `_append` lists 
available for adding flags not present by default:

```yaml
_nginx_user_settings:
  conf:
    _prepend:
      - custom_flag_here value_here
    _append:
      - custom_flag_here value_here
```
These custom flags are added near the top and bottom of each section.

role settings
-------------

Controlled via `_nginx_user_settings.settings` dict.

Not directly used as values in templates, used to configure the package itself.

`_prepend` and `_append` not applicable.

**`conf_purge`**

Remove conf files not generated by Ansible.

Boolean

Default: `true`

**`default_server`**

Create default server at `/var/www/html` with a single `index.html` file.

Boolean

Default: `true`

**`global_dir_mode`**

Mode for conf directories.

String

Default: `'0755'`

**`global_file_mode`**

Mode for conf files.

String

Default: `'0644''`

**`global_group`**

Group for conf directories.

String

Default: `root`

**`global_owner`**

Owner for conf directories.

String

Default: `root`

**`log_group`**

Group for log directory.

String

Default: Depends on operating system.

* Debian: `adm`

**`log_mode`**

Mode for log directory.

String

Default: `'0750'`

**`manage_repo`**

Manage repos required by role. Uses official nginx.org repos.

If set to `false` you must add the repo yourself before calling this role.

Boolean

Default: `true`

**`package_state`**

See: [package_module](http://docs.ansible.com/ansible/latest/package_module.html)

String

Default: `present`

**`package_name`**

Package name from selected repo.

String

Default: `nginx`

**`package_source`**

Repo version.

String:

* `nginx` - Stable version (use this in production).
* `nginx-stable` - Same as `nginx`
* `nginx-mainline` - Active development version.
* `passenger` - Installs nginx from [phusionpassenger.com](https://phusionpassenger.com)

Default: `nginx`

**`passenger_package_state`**

State of `passenger` package. Only applicable if `settings.package_source` is set to `passenger`.

See: [package_module](http://docs.ansible.com/ansible/latest/package_module.html)

String

Default: `present`

**`root_group`**

Root group.

String

Default: `root`

**`server_purge`**

Remove server files not generated by Ansible.

Files removed from `sites-available` and `sites-enabled`.

Boolean

Default: `true`

**`service_enabled`**

Whether the service should start on boot.
See [service_module](http://docs.ansible.com/ansible/latest/service_module.html)

Only applicable if `settings.service_manage` is `true`.

String

Default: `'yes`

**`service_manage`**

Automatically manage Nginx service.

Boolean

Default: `true`

**`service_name`**

Name of nginx service.

Only applicable if `settings.service_manage` is `true`.

String

Default: `nginx`

**`service_state`**

See [service_module](http://docs.ansible.com/ansible/latest/service_module.html)

Only applicable if `settings.service_manage` is `true`.

String

Default: `started`

**`sites_available_group`**

Group for `sites-available` directory.

String

Default: `root`

**`sites_available_mode`**

Mode for `sites-available` directory.

String

Default: `'0755'`

**`sites_available_owner`**

Owner for `sites-available` directory.

String

Default: `root`

nginx.conf
----------

With default values the generated file looks similar to this:

```
user                            www-data;
worker_processes                1;
worker_rlimit_nofile            1024;
pid                             /var/run/nginx.pid;
error_log                       /var/log/nginx/error.log error;
events {
  accept_mutex                  off;
  accept_mutex_delay            500ms;
  worker_aio_requests           32;
  worker_connections            1024;
}

http {
  include                       /etc/nginx/mime.types;
  default_type                  application/octet-stream;

  access_log                    /var/log/nginx/access.log;

  sendfile                      on;
  server_tokens                 on;
  types_hash_max_size           1024;
  types_hash_bucket_size        512;
  server_names_hash_bucket_size 64;
  server_names_hash_max_size    512;
  keepalive_timeout             65;
  keepalive_requests            100;
  client_body_timeout           60;
  send_timeout                  60;
  lingering_timeout             5;
  tcp_nodelay                   on;

  gzip                          on;
  gzip_comp_level               1;
  gzip_disable                  msie6;
  gzip_min_length               20;
  gzip_http_version             1.1;
  gzip_proxied                  off;
  gzip_vary                     off;

  client_body_temp_path         /var/nginx/client_body_temp;
  client_max_body_size          10m;
  client_body_buffer_size       128k;
  proxy_temp_path               /var/nginx/proxy_temp;
  proxy_connect_timeout         90;
  proxy_send_timeout            90;
  proxy_read_timeout            90;
  proxy_buffers                 32 4k;
  proxy_buffer_size             8k;
  proxy_set_header              Host $host;
  proxy_set_header              X-Real-IP $remote_addr;
  proxy_set_header              X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header              Proxy "";
  proxy_headers_hash_bucket_size 64;

  include                       /etc/nginx/conf.d/*.conf;
  include                       /etc/nginx/sites-enabled/*;
}
```

#### main section

All available options can be seen under `_nginx_conf` dict.

Controlled via `_nginx_user_settings.conf` dict, writes to `/etc/nginx/nginx.conf`.

See: [core_module](http://nginx.org/en/docs/ngx_core_module.html)

**`conf_dir`**

Base configuration directory.

String

Default: `/etc/nginx`

**`daemon`**

String

Default: `null`

**`daemon_user`**

Only applicable if `conf.super_user` is `true`.

String

Default: `nginx`

**`error_log`**

Can be a string or a list of strings. `conf.error_log_severity` must also be defined.

String/String[]

Default: `{{ conf.log_dir }}/error.log`

**`error_log_severity`**

Used by `conf.error_log`.

String

Default: `error`

**`events`**

See *events section*

**`http`**

See *http section*

**`log_dir`**

Log directory.

String

Default: `/var/log/nginx`

**`mail`**

Include `conf.mail.d` conf files.

Boolean

Default: `false`

**`pid`**

String

Default: `/var/run/nginx.pid`

**`run_dir`**

String

Default: `/var/nginx`

**`stream`**

Include `conf.stream.d` and `streams-enabled` conf files.

Boolean

Default: `false`

**`super_user`**

Required for using `conf.daemon_user`.

Boolean

Default: `true`

**`worker_processes`**

Int

Default: `1`

**`worker_rlimit_nofile`**

Int

Default: `1024`

#### events section

All available options can be seen under `_nginx_conf_events` dict.

Controlled via `_nginx_user_settings.conf.events` dict.

See: [core_module#events](http://nginx.org/en/docs/ngx_core_module.html#events)

**`accept_mutex`**

String

Default: `'off'`

**`accept_mutex_delay`**

String

Default: `500ms`

**`debug_connection`**

String[]

Default: `[]`

**`multi_accept`**

Only applicable if `'on'`

String

Default: `'off'`

**`use`**

String

Default: `null`

**`worker_aio_requests`**

Int

Default: `32`

**`worker_connections`**

Int

Default: `1024`

#### http section

All available options can be seen under `_nginx_conf_http` dict.

Controlled via `_nginx_user_settings.conf.http` dict.

**`access_log`**

String

Default: `{{ conf.log_dir }}/access.log`

**`access_log_format`**

String

Default: `null`

**`client_body_buffer_size`**

String

Default: `128k`

**`client_body_temp_path`**

String

Default: `{{ conf.run_dir }}/client_body_temp`

**`client_body_timeout`**

Int

Default: `60`

**`client_max_body_size`**

String

Default: `10m`

**`fastcgi_cache`**

See `http.fastcgi_cache` section.

**`fastcgi_cache_key`**

String

Default: `null`

**`fastcgi_cache_use_stale`**

String

Default: `null`

**`gzip`**

String

Default: `on`

**`gzip_buffers`**

Only applicable if `conf.http.gzip` is `'on'`.

String

Default: `null`

**`gzip_comp_level`**

Only applicable if `conf.http.gzip` is `'on'`.

Int

Default: `1`

**`gzip_disable`**

Only applicable if `conf.http.gzip` is `'on'`.

String

Default: `msie6`

**`gzip_http_version`**

Only applicable if `conf.http.gzip` is `'on'`.

String

Default: `1.1`

**`gzip_min_length`**

Only applicable if `conf.http.gzip` is `'on'`.

Int

Default: `20`

**`gzip_proxied`**

Only applicable if `conf.http.gzip` is `'on'`.

String

Default: `'off'`

**`gzip_types`**

Only applicable if `conf.http.gzip` is `'on'`.

String/String[]

Default: `null`

**`gzip_vary`**

Only applicable if `conf.http.gzip` is `'on'`.

Default: `'off'`

**`keepalive_timeout`**

Int

Default: `65`

**`keepalive_requests`**

Int

Default: `100`

**`lingering_timeout`**

Int

Default: `5`

**`log_format`**

String[]

Default: `[]`

**`proxy_buffer_size`**

String

Default: `8k`

**`proxy_buffers`**

String

Default: `32 4k`

**`proxy_cache`**

See `http.proxy_cache` section.

**`proxy_connect_timeout`**

Int

Default: `90`

**`proxy_headers_hash_bucket_size`**

Int

Default: `64`

**`proxy_hide_header`**

String[]

Default: `[]`

**`proxy_http_version`**

String

Default: `null`

**`proxy_pass_header`**

String[]

Default: `[]`

**`proxy_read_timeout`**

Int

Default: `90`

**`proxy_redirect`**

String

Default: `null`

**`proxy_send_timeout`**

Int

Default: `90`

**`proxy_set_header`**

String[]

Default:

```yaml
[
  - Host $host
  - X-Real-IP $remote_addr
  - X-Forwarded-For $proxy_add_x_forwarded_for
  - Proxy ""
]
```

**`proxy_temp_path`**

String

Default: `{{ conf.run_dir }}/proxy_temp`

**`sendfile`**

String

Default: `'on'`

**`send_timeout`**

Int

Default: `60`

**`server_tokens`**

String

Default: `'on'`

**`tcp_nopush`**

String

Default: `'off'`

**`server_names_hash_bucket_size`**

Int

Default: `64`

**`server_names_hash_max_size`**

Int

Default: `512`

**`tcp_nodelay`**

String

Default: `'on'`

**`types_hash_bucket_size`**

Int

Default: `512`

**`types_hash_max_size`**

Int

Default: `1024`

#### http.fastcgi_cache section

All available options can be seen under `_nginx_conf_http_fastcgi_cache` dict.

Controlled via `_nginx_user_settings.conf.http.fastcgi_cache` list.

Simply define one or more lists of dict type:

```yaml
_nginx_user_settings:
  conf:
    http:
      fastcgi_cache:
        -
          inactive: 20m
          keys_zone: d2:100m
          levels: 1
          max_size: 500m
          path: /path/to/fastcgi.cache
```

The generated line(s) will look similar to this:

`fastcgi_cache_path            /path/to/fastcgi.cache levels=1 keys_zone=d2:100m max_size=500m inactive=20m;`

**`inactive`**

String

Default: `20m`

**`keys_zone`**

String

Default: `d2:100m`

**`levels`**

Int

Default: `1`

**`max_size`**

String

Default: `500m`

**`path`**

Path to fastcgi cache file. Must be defined.

String

Default: `null`

#### http.proxy_cache section

All available options can be seen under `_nginx_conf_http_proxy_cache` dict.

Controlled via `_nginx_user_settings.conf.http.proxy_cache` list.

Simply define one or more lists of dict type:

```yaml
_nginx_user_settings:
  conf:
    http:
      proxy_cache:
        -
          inactive: 20m
          keys_zone: d2:100m
          levels: 1
          loader_files: ~
          loader_sleep: ~
          loader_threshold: ~
          max_size: 500m
          path: /path/to/proxy.cache
          use_temp_path: ~
```

The generated line(s) will look similar to this:

`proxy_cache_path              /path/to/proxy.cache keys_zone=d2:100m levels=1 max_size=500m inactive=20m;`

**`inactive`**

String

Default: `20m`

**`keys_zone`**

String

Default: `d2:100m`

**`levels`**

Int

Default: `1`

**`loader_files`**

String

Default: `null`

**`loader_sleep`**

String

Default: `null`

**`loader_threshold`**

String

Default: `null`

**`max_size`**

String

Default: `500m`

**`path`**

Path to proxy cache file. Must be defined.

String

Default: `null`

**`use_temp_path`**

Only applicable if `settings.http.proxy_temp_path` is set.

geo settings
------------

Controlled via `_nginx_user_settings.geo` dict, writes to `/etc/nginx/conf.d/`.

See: [geo_module](http://nginx.org/en/docs/http/ngx_http_geo_module.html)

Example:

```yaml
_nginx_user_settings:
  geo:
    -
      name: local
      address: ~
      default: extra
      delete: ~
      network:
          - '10.0.0.0/8 intra'
          - '172.16.0.0/12 intra'
          - '192.168.0.0/16 intra'
      proxy:
          - 192.168.99.99
      proxy_recursive: false
      ranges: false 
```

The generated file will look similar to this:

```
geo $local {
  default extra;
  proxy 192.168.99.99;
  10.0.0.0/8 intra;
  172.16.0.0/12 intra;
  192.168.0.0/16 intra;
}
```

**`name`**

Used next to `geo` keyword. `$` is prepended automatically, do not add.

Required.

String

Default: `null`

**`address`**

If defined, added before `geo.name` value.

String

Default: `null`

**`default`**

String

Default: `null`

**`delete`**

String

Default: `null`

**`network`**

String[]

Default: `[]`

**`proxy`**

String[]

Default: `[]`

**`proxy_recursive`**

Boolean

Default: `false`

**`ranges`**

Boolean

Default: `false`

map settings
------------

Controlled via `_nginx_user_settings.map` dict, writes to `/etc/nginx/conf.d/`.

See: [map_module](http://nginx.org/en/docs/http/ngx_http_map_module.html)

Example:

```yaml
_nginx_user_settings:
  map:
    -
      name: backend_pool
      hostnames: true
      default: ny-pool-1
      string: $http_host
      mapping:
        - '*.nyc.example.com ny-pool-1'
        - '*.sf.example.com sf-pool-1'
```

The generated file will look similar to this:

```
map $http_host $backend_pool {
  hostnames;
  default ny-pool-1;

  *.nyc.example.com ny-pool-1;
  *.sf.example.com  sf-pool-1;
}
```

**`name`**

Used next to `map` keyword. `$` is prepended automatically, do not add.

Required.

String

Default: `null`

**`default`**

String

Default: `null`

**`hostnames`**

Boolean

Default: `false`

**`mapping`**

String[]

Default: []

**`string`**

If defined, added before `map.name` value.

String

Default: `null`

upstream settings
-----------------

Controlled via `_nginx_user_settings.upstream` dict, writes to `/etc/nginx/conf.d/` or `/etc/nginx/conf.stream.d/`.

See: [upstream_module](http://nginx.org/en/docs/http/ngx_http_upstream_module.html)

Example:

```yaml
_nginx_user_settings:
  upstream:
    -
      name: backendA
      context: http
      server:
        - 'localhost:3000 weight=5'
        - 'localhost:3001 fail_timeout=5s'
```

The generated file will look similar to this:

```
upstream backendA {
  server     localhost:3000 weight=5;
  server     localhost:3001 fail_timeout=5s;
}
```

**`name`**

Used next to `upstream` keyword.

Required.

String

**`context`**

If `http` conf file created in `/etc/nginx/conf.d/`.

If `stream` conf file created in `/etc/nginx/conf.stream.d/`.

String

Default: `http`

**`server`**

String[]

Default: `[]`
