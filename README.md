jtreminio.nginx
===============

This role installs and configures nginx. It features sane defaults while allowing
a user to create a highly configured installation.

This role was created from [Vox Pupuli's puppet-nginx](https://github.com/voxpupuli/puppet-nginx)
and most settings closely track that project's.

Requirements
------------

`jtreminio.common` for some Python modules and firewall management, if wanted.

Install
-------

requirements.yml:

```yaml
- name: jtreminio.nginx
  src: https://github.com/jtreminio/ansible-nginx
```

Usage
-----

Sane defaults come included, but everything is configurable.

All settings are controlled by a single dict `_nginx_user_settings`:

```yaml
- set_fact:
    _nginx_user_settings:
      conf:
        error_log_severity: error
        pid: /var/run/nginx.pid
        events:
          worker_connections: 512
          use: epoll
          multi_accept: 'on'
        http:
          gzip: 'on'
          gzip_disable: msie6

- include_role:
    name: jtreminio.nginx
```

Variables
---------

If set to `~` (`null`) or `false`, most variables will not be used.

For example, to not configure the `daemon` value:

```yaml
_nginx_user_settings:
  conf:
    daemon: ~
```

Some variables require a specific value to be used, usually `'on'`. For example:

```yaml
_nginx_user_settings:
  conf:
    events:
      multi_accept: 'on'
    http:
      gzip: 'on'
      sendfile: 'on'
      tcp_nodelay: 'on'
```

Please note that due to stupid design decisions by YAML, you must ensure `on` is surrounded by
single quotes, `'on'`, else YAML silently turns the value into boolean `true`.

The same is true of `off` turning into boolean `false` and requiring `'off'`.

Settings
========

Please look in `defaults/main.yml` for all available options.

Do _not_ add `;` after any option. These are added automatically.

Unless otherwise noted, all sections have `_prepend` and `_append` lists 
available for adding flags not present by default:

```yaml
_nginx_user_settings:
  conf:
    _prepend:
      - custom_flag_here value_here
    _append:
      - custom_flag_here value_here
```
These custom flags are added near the top and bottom of each section.

role settings
-------------

Controlled via `_nginx_user_settings.settings` dict.

Not directly used as values in templates, used to configure the package itself.

`_prepend` and `_append` not applicable.

**`conf_purge`**

Remove conf files not generated by Ansible.

Boolean

Default: `true`

**`default_server`**

Create default server at `/var/www/html` with a single `index.html` file.

Boolean

Default: `true`

**`global_dir_mode`**

Mode for conf directories.

String

Default: `'0755'`

**`global_file_mode`**

Mode for conf files.

String

Default: `'0644''`

**`global_group`**

Group for conf directories.

String

Default: `root`

**`global_owner`**

Owner for conf directories.

String

Default: `root`

**`log_group`**

Group for log directory.

String

Default: Depends on operating system.

* Debian: `adm`

**`log_mode`**

Mode for log directory.

String

Default: `'0750'`

**`manage_repo`**

Manage repos required by role. Uses official nginx.org repos.

If set to `false` you must add the repo yourself before calling this role.

Boolean

Default: `true`

**`package_state`**

See: [package_module](http://docs.ansible.com/ansible/latest/package_module.html)

String

Default: `present`

**`package_name`**

Package name from selected repo.

String

Default: `nginx`

**`package_source`**

Repo version.

String:

* `nginx` - Stable version (use this in production).
* `nginx-stable` - Same as `nginx`
* `nginx-mainline` - Active development version.
* `passenger` - Installs nginx from [phusionpassenger.com](https://phusionpassenger.com)

Default: `nginx`

**`passenger_package_state`**

State of `passenger` package. Only applicable if `settings.package_source` is set to `passenger`.

See: [package_module](http://docs.ansible.com/ansible/latest/package_module.html)

String

Default: `present`

**`root_group`**

Root group.

String

Default: `root`

**`server_purge`**

Remove server files not generated by Ansible.

Files removed from `sites-available` and `sites-enabled`.

Boolean

Default: `true`

**`service_enabled`**

Whether the service should start on boot.
See [service_module](http://docs.ansible.com/ansible/latest/service_module.html)

Only applicable if `settings.service_manage` is `true`.

String

Default: `'yes`

**`service_manage`**

Automatically manage Nginx service.

Boolean

Default: `true`

**`service_name`**

Name of nginx service.

Only applicable if `settings.service_manage` is `true`.

String

Default: `nginx`

**`service_state`**

See [service_module](http://docs.ansible.com/ansible/latest/service_module.html)

Only applicable if `settings.service_manage` is `true`.

String

Default: `started`

**`sites_available_group`**

Group for `sites-available` directory.

String

Default: `root`

**`sites_available_mode`**

Mode for `sites-available` directory.

String

Default: `'0755'`

**`sites_available_owner`**

Owner for `sites-available` directory.

String

Default: `root`

nginx.conf
----------

With default values the generated file looks similar to this:

```
user                            www-data;
worker_processes                1;
worker_rlimit_nofile            1024;
pid                             /var/run/nginx.pid;
error_log                       /var/log/nginx/error.log error;
events {
  accept_mutex                  off;
  accept_mutex_delay            500ms;
  worker_aio_requests           32;
  worker_connections            1024;
}

http {
  include                       /etc/nginx/mime.types;
  default_type                  application/octet-stream;

  access_log                    /var/log/nginx/access.log;

  sendfile                      on;
  server_tokens                 on;
  types_hash_max_size           1024;
  types_hash_bucket_size        512;
  server_names_hash_bucket_size 64;
  server_names_hash_max_size    512;
  keepalive_timeout             65;
  keepalive_requests            100;
  client_body_timeout           60;
  send_timeout                  60;
  lingering_timeout             5;
  tcp_nodelay                   on;

  gzip                          on;
  gzip_comp_level               1;
  gzip_disable                  msie6;
  gzip_min_length               20;
  gzip_http_version             1.1;
  gzip_proxied                  off;
  gzip_vary                     off;

  client_body_temp_path         /var/nginx/client_body_temp;
  client_max_body_size          10m;
  client_body_buffer_size       128k;
  proxy_temp_path               /var/nginx/proxy_temp;
  proxy_connect_timeout         90;
  proxy_send_timeout            90;
  proxy_read_timeout            90;
  proxy_buffers                 32 4k;
  proxy_buffer_size             8k;
  proxy_set_header              Host $host;
  proxy_set_header              X-Real-IP $remote_addr;
  proxy_set_header              X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header              Proxy "";
  proxy_headers_hash_bucket_size 64;

  include                       /etc/nginx/conf.d/*.conf;
  include                       /etc/nginx/sites-enabled/*;
}
```

#### main section

All available options can be seen under `_nginx_conf` dict.

Controlled via `_nginx_user_settings.conf` dict, writes to `/etc/nginx/nginx.conf`.

See: [core_module](http://nginx.org/en/docs/ngx_core_module.html)

**`conf_dir`**

Base configuration directory.

String

Default: `/etc/nginx`

**`daemon`**

String

Default: `null`

**`daemon_user`**

Only applicable if `conf.super_user` is `true`.

String

Default: `nginx`

**`error_log`**

Can be a string or a list of strings. `conf.error_log_severity` must also be defined.

String/String[]

Default: `{{ conf.log_dir }}/error.log`

**`error_log_severity`**

Used by `conf.error_log`.

String

Default: `error`

**`events`**

See *events section*

**`http`**

See *http section*

**`log_dir`**

Log directory.

String

Default: `/var/log/nginx`

**`mail`**

Include `conf.mail.d` conf files.

Boolean

Default: `false`

**`pid`**

String

Default: `/var/run/nginx.pid`

**`run_dir`**

String

Default: `/var/nginx`

**`stream`**

Include `conf.stream.d` and `streams-enabled` conf files.

Boolean

Default: `false`

**`super_user`**

Required for using `conf.daemon_user`.

Boolean

Default: `true`

**`worker_processes`**

Int

Default: `1`

**`worker_rlimit_nofile`**

Int

Default: `1024`

#### events section

All available options can be seen under `_nginx_conf_events` dict.

Controlled via `_nginx_user_settings.conf.events` dict.

See: [core_module#events](http://nginx.org/en/docs/ngx_core_module.html#events)

**`accept_mutex`**

String

Default: `'off'`

**`accept_mutex_delay`**

String

Default: `500ms`

**`debug_connection`**

String[]

Default: `[]`

**`multi_accept`**

Only applicable if `'on'`

String

Default: `'off'`

**`use`**

String

Default: `null`

**`worker_aio_requests`**

Int

Default: `32`

**`worker_connections`**

Int

Default: `1024`

#### http section

All available options can be seen under `_nginx_conf_http` dict.

Controlled via `_nginx_user_settings.conf.http` dict.

**`access_log`**

String

Default: `{{ conf.log_dir }}/access.log`

**`access_log_format`**

String

Default: `null`

**`client_body_buffer_size`**

String

Default: `128k`

**`client_body_temp_path`**

String

Default: `{{ conf.run_dir }}/client_body_temp`

**`client_body_timeout`**

Int

Default: `60`

**`client_max_body_size`**

String

Default: `10m`

**`fastcgi_cache`**

See `http.fastcgi_cache` section.

**`fastcgi_cache_key`**

String

Default: `null`

**`fastcgi_cache_use_stale`**

String

Default: `null`

**`gzip`**

String

Default: `on`

**`gzip_buffers`**

Only applicable if `conf.http.gzip` is `'on'`.

String

Default: `null`

**`gzip_comp_level`**

Only applicable if `conf.http.gzip` is `'on'`.

Int

Default: `1`

**`gzip_disable`**

Only applicable if `conf.http.gzip` is `'on'`.

String

Default: `msie6`

**`gzip_http_version`**

Only applicable if `conf.http.gzip` is `'on'`.

String

Default: `1.1`

**`gzip_min_length`**

Only applicable if `conf.http.gzip` is `'on'`.

Int

Default: `20`

**`gzip_proxied`**

Only applicable if `conf.http.gzip` is `'on'`.

String

Default: `'off'`

**`gzip_types`**

Only applicable if `conf.http.gzip` is `'on'`.

String/String[]

Default: `null`

**`gzip_vary`**

Only applicable if `conf.http.gzip` is `'on'`.

Default: `'off'`

**`keepalive_timeout`**

Int

Default: `65`

**`keepalive_requests`**

Int

Default: `100`

**`lingering_timeout`**

Int

Default: `5`

**`log_format`**

String[]

Default: `[]`

**`proxy_buffer_size`**

String

Default: `8k`

**`proxy_buffers`**

String

Default: `32 4k`

**`proxy_cache`**

See `http.proxy_cache` section.

**`proxy_connect_timeout`**

Int

Default: `90`

**`proxy_headers_hash_bucket_size`**

Int

Default: `64`

**`proxy_hide_header`**

String[]

Default: `[]`

**`proxy_http_version`**

String

Default: `null`

**`proxy_pass_header`**

String[]

Default: `[]`

**`proxy_read_timeout`**

Int

Default: `90`

**`proxy_redirect`**

String

Default: `null`

**`proxy_send_timeout`**

Int

Default: `90`

**`proxy_set_header`**

String[]

Default:

```yaml
[
  - Host $host
  - X-Real-IP $remote_addr
  - X-Forwarded-For $proxy_add_x_forwarded_for
  - Proxy ""
]
```

**`proxy_temp_path`**

String

Default: `{{ conf.run_dir }}/proxy_temp`

**`sendfile`**

String

Default: `'on'`

**`send_timeout`**

Int

Default: `60`

**`server_tokens`**

String

Default: `'on'`

**`tcp_nopush`**

String

Default: `'off'`

**`server_names_hash_bucket_size`**

Int

Default: `64`

**`server_names_hash_max_size`**

Int

Default: `512`

**`tcp_nodelay`**

String

Default: `'on'`

**`types_hash_bucket_size`**

Int

Default: `512`

**`types_hash_max_size`**

Int

Default: `1024`

#### http.fastcgi_cache section

All available options can be seen under `_nginx_conf_http_fastcgi_cache` dict.

Controlled via `_nginx_user_settings.conf.http.fastcgi_cache` list.

Simply define one or more lists of dict type:

```yaml
_nginx_user_settings:
  conf:
    http:
      fastcgi_cache:
        -
          inactive: 20m
          keys_zone: d2:100m
          levels: 1
          max_size: 500m
          path: /path/to/fastcgi.cache
```

The generated line(s) will look similar to this:

`fastcgi_cache_path            /path/to/fastcgi.cache levels=1 keys_zone=d2:100m max_size=500m inactive=20m;`

**`inactive`**

String

Default: `20m`

**`keys_zone`**

String

Default: `d2:100m`

**`levels`**

Int

Default: `1`

**`max_size`**

String

Default: `500m`

**`path`**

Path to fastcgi cache file. Must be defined.

String

Default: `null`

#### http.proxy_cache section

All available options can be seen under `_nginx_conf_http_proxy_cache` dict.

Controlled via `_nginx_user_settings.conf.http.proxy_cache` list.

Simply define one or more lists of dict type:

```yaml
_nginx_user_settings:
  conf:
    http:
      proxy_cache:
        -
          inactive: 20m
          keys_zone: d2:100m
          levels: 1
          loader_files: ~
          loader_sleep: ~
          loader_threshold: ~
          max_size: 500m
          path: /path/to/proxy.cache
          use_temp_path: ~
```

The generated line(s) will look similar to this:

`proxy_cache_path              /path/to/proxy.cache keys_zone=d2:100m levels=1 max_size=500m inactive=20m;`

**`inactive`**

String

Default: `20m`

**`keys_zone`**

String

Default: `d2:100m`

**`levels`**

Int

Default: `1`

**`loader_files`**

String

Default: `null`

**`loader_sleep`**

String

Default: `null`

**`loader_threshold`**

String

Default: `null`

**`max_size`**

String

Default: `500m`

**`path`**

Path to proxy cache file. Must be defined.

String

Default: `null`

**`use_temp_path`**

Only applicable if `settings.http.proxy_temp_path` is set.

geo settings
------------

Controlled via `_nginx_user_settings.geo` dict, writes to `/etc/nginx/conf.d/`.

See: [geo_module](http://nginx.org/en/docs/http/ngx_http_geo_module.html)

Example:

```yaml
_nginx_user_settings:
  geo:
    -
      name: local
      address: ~
      default: extra
      delete: ~
      network:
          - '10.0.0.0/8 intra'
          - '172.16.0.0/12 intra'
          - '192.168.0.0/16 intra'
      proxy:
          - 192.168.99.99
      proxy_recursive: false
      ranges: false 
```

The generated file will look similar to this:

```
geo $local {
  default extra;
  proxy 192.168.99.99;
  10.0.0.0/8 intra;
  172.16.0.0/12 intra;
  192.168.0.0/16 intra;
}
```

**`name`**

Used next to `geo` keyword. `$` is prepended automatically, do not add.

Required.

String

Default: `null`

**`address`**

If defined, added before `geo.name` value.

String

Default: `null`

**`default`**

String

Default: `null`

**`delete`**

String

Default: `null`

**`network`**

String[]

Default: `[]`

**`proxy`**

String[]

Default: `[]`

**`proxy_recursive`**

Boolean

Default: `false`

**`ranges`**

Boolean

Default: `false`

map settings
------------

Controlled via `_nginx_user_settings.map` dict, writes to `/etc/nginx/conf.d/`.

See: [map_module](http://nginx.org/en/docs/http/ngx_http_map_module.html)

Example:

```yaml
_nginx_user_settings:
  map:
    -
      name: backend_pool
      hostnames: true
      default: ny-pool-1
      string: $http_host
      mapping:
        - '*.nyc.example.com ny-pool-1'
        - '*.sf.example.com sf-pool-1'
```

The generated file will look similar to this:

```
map $http_host $backend_pool {
  hostnames;
  default ny-pool-1;

  *.nyc.example.com ny-pool-1;
  *.sf.example.com  sf-pool-1;
}
```

**`name`**

Used next to `map` keyword. `$` is prepended automatically, do not add.

Required.

String

Default: `null`

**`default`**

String

Default: `null`

**`hostnames`**

Boolean

Default: `false`

**`mapping`**

String[]

Default: []

**`string`**

If defined, added before `map.name` value.

String

Default: `null`

upstream settings
-----------------

Controlled via `_nginx_user_settings.upstream` dict, writes to `/etc/nginx/conf.d/` or `/etc/nginx/conf.stream.d/`.

See: [upstream_module](http://nginx.org/en/docs/http/ngx_http_upstream_module.html)

Example:

```yaml
_nginx_user_settings:
  upstream:
    -
      name: backendA
      context: http
      server:
        - 'localhost:3000 weight=5'
        - 'localhost:3001 fail_timeout=5s'
```

The generated file will look similar to this:

```
upstream backendA {
  server     localhost:3000 weight=5;
  server     localhost:3001 fail_timeout=5s;
}
```

**`name`**

Used next to `upstream` keyword.

Required.

String

**`context`**

If `http` conf file created in `/etc/nginx/conf.d/`.

If `stream` conf file created in `/etc/nginx/conf.stream.d/`.

String

Default: `http`

**`server`**

String[]

Default: `[]`

server settings
-----------------

Controlled via `_nginx_user_settings.server` list, writes to `/etc/nginx/servers-available/`.

See: [core_module#server](http://nginx.org/en/docs/http/ngx_http_core_module.html#server)

Example:

```yaml
_nginx_user_settings:
  server:
    -
      rewrite_www_to_non_www: 0
      server_name:
        - awesome.dev
        - www.awesome.dev
      listen:
        - '*:80'
      root: /var/www/awesome/web
      rewrite:
        -
          regex: '^/dashboard$'
          target: '/admin.php?controller=user&action=login last'
      location:
        -
          root: /var/www/awesome/web
          location: /
          autoindex: 'on'
          index:
            - index.php
          try_files:
            - $uri
            - $uri/
            - /index.php$is_args$args
        -
          root: /var/www/awesome/web
          location: '~ ^/index\.php(/|$)'
          index: ~
          try_files:
            - $uri
            - $uri/
            - /index.php$is_args$args
          fastcgi_pass: '127.0.0.1:9000'
          fastcgi_index: index.php
          fastcgi_split_path_info: '^(.+\.php)(/.*)$'
          fastcgi_param:
            - 'SCRIPT_FILENAME $document_root$fastcgi_script_name'
            - 'APP_ENV dev'
          set:
            - '$path_info $fastcgi_path_info'
```

The generated file will look similar to this:

```
server {
  listen                    *:80;
  server_name               awesome.dev www.awesome.dev;

  client_body_timeout       12;
  client_header_timeout     12;
  client_max_body_size      8m;
  gzip_types                text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
  root                      /var/www/awesome/web;
  resolver                  8.8.8.8 8.8.4.4;
  index                     index.html index.htm;
  access_log                /var/log/nginx/awesome.dev.access.log combined;
  error_log                 /var/log/nginx/awesome.dev.error.log;

  location / {
    autoindex               on;
    index                   index.php;
    try_files               $uri $uri/ /index.php$is_args$args;
  }

  location ~ ^/index\.php(/|$) {
    set                     $path_info $fastcgi_path_info;
    include                 /etc/nginx/fastcgi_params;
    fastcgi_pass            127.0.0.1:9000;
    fastcgi_index           index.php;
    fastcgi_split_path_info ^(.+\.php)(/.*)$;
    fastcgi_param           SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param           APP_ENV dev;
    autoindex               on;
    try_files               $uri $uri/ /index.php$is_args$args;
  }
}
```

#### main section

**`rewrite_www_to_non_www`**

Redirects all www traffic to non-www.

ie: www.google.com -> google.com

Adds code similar to:

```
server {
  listen *:80;
  server_name www.awesome.dev;
  return 301 http://awesome.dev$request_uri;
}
```

Boolean

Default: `false`

**`server_name`**

Domain names for this server. The first entry defined will be used as the conf file name:

```yaml
_nginx_user_settings:
  server:
    -
      server_name:
        - awesome.dev
        - www.awesome.dev
```

Will result in file `/etc/nginx/sites-available/001-awesome.dev.conf` or similar.

String[]

Default: []

**`listen`**

Ports to listen for this server. Can use IPv6.

```yaml
_nginx_user_settings:
  server:
    -
      listen:
        - '*:80'
        - '[::]:80'
        - 443 default ssl http2
```

String[]

Default: []

**`root`**

String

Default: `null`

**`index_files`**

String[]

Default: 
```yaml
[
  - index.html
  - index.htm
]
```

**`access_log`**

If `null`, will use first `location.server_name` entry:

`/var/log/nginx/awesome.dev.access.log`

Uses `server.format_log`

String|String[]

Default: `null`

**`add_header`**

String[]

Default: []

**`allow_deny`**

String[]

Default: []

**`auth_basic`**

String[]

Default: []

**`auth_basic_user_file`**

String

Default: `null`

**`auth_request`**

String

Default: `null`

**`client_body_timeout`**

Int

Default: `12`

**`client_header_timeout`**

Int

Default: `12`

**`client_max_body_size`**

String

Default: `8m`

**`error_log`**

If `null`, will use first `location.server_name` entry:

`/var/log/nginx/awesome.dev.error.log`

String|String[]

Default: `null`

**`error_page`**

String[]

Default: `[]`

**`format_log`**

Used by Uses `server.access_log`

String

Default: `combined`

**`geo`**

See [geo settings](#geo-settings)

Default: `[]`

**`gzip_types`**

String[]

Default:
```yaml
[
    - text/plain
    - text/css
    - application/json
    - application/x-javascript
    - text/xml
    - application/xml
    - application/xml+rss
    - text/javascript
]
```

**`include`**

String[]

Default: `[]`

**`log_by_lua`**

String

Default: `null`

**`log_by_lua_file`**

String

Default: `null`

**`maintenance`**

Boolean

Default: `null`

**`maintenance_value`**

Only applicable if `server.maintenance` is `true`.

String

Default: `null`

**`map`**

See [map settings](#map-settings)

Default: `[]`

**`passenger_cgi_param`**

String[]

Default: `[]`

**`passenger_env_var`**

String[]

Default: `[]`

**`passenger_pre_start`**

String|String[]

Default: `null`

**`passenger_set_header`**

String[]

Default: `[]`

**`proxy_set_header`**

String[]

Default:
```yaml
[
    - Host $host
    - X-Real-IP $remote_addr
    - X-Forwarded-For $proxy_add_x_forwarded_for
    - Proxy ""
]
```

**`resolver`**

String[]

Default:
```yaml
[
    - 8.8.8.8
    - 8.8.4.4
]
```

**`ssl`**

Enables SSL support for server.

Boolean

Default: `false`

**`ssl_certificate`**

Only applicable if `ssl` is set to `true`.

Uses unsecure cert for testing purposes.

String

Default: `/etc/ssl/certs/ssl-cert-snakeoil.pem`

**`ssl_certificate_key`**

Only applicable if `ssl` is set to `true`.

Uses unsecure key for testing purposes.

String

Default: `/etc/ssl/private/ssl-cert-snakeoil.key`

**`ssl_ciphers`**

Only applicable if `ssl` is set to `true`.

String

Default: `EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH`

**`ssl_ecdh_curve`**

Only applicable if `ssl` is set to `true`.

String

Default: `secp384r1`

**`ssl_prefer_server_ciphers`**

String

Default: `'on'`

**`ssl_protocols`**

String

Default: `TLSv1.2`

**`ssl_redirect`**

Only applicable if `ssl` is set to `true`.

Redirects all traffic to https

Boolean

Default: `false`

**`ssl_session_cache`**

Only applicable if `ssl` is set to `true`.

String

Default: `shared:SSL:10m`

**`ssl_session_tickets`**

Only applicable if `ssl` is set to `true`.

String

Default: `'off'`

**`ssl_session_timeout`**

Only applicable if `ssl` is set to `true`.

String

Default: `5m`

**`ssl_stapling`**

Only applicable if `ssl` is set to `true`.

String

Default: `'on'`

**`ssl_stapling_verify`**

Only applicable if `ssl` is set to `true`.

String

Default: `'on'`

#### server.rewrite section

List of dict within `server` dict.

Must contain at least `regex` and `target` elements, with `when` as optional.

Example:
```yaml
_nginx_user_settings:
  server:
    -
      rewrite:
        -
          regex: '^/page-([0-9]+)$'
          target: '/index.php?controller=blog&action=view&page=$1 last'
        -
          when: '$w3tc_rewrite = 1'
          regex: '^'
          target: '"/wp-content/cache/page_enhanced/$host/$request_uri/_index$w3tc_ua$w3tc_ref$w3tc_ssl$w3tc_ext$w3tc_enc" last'

```

The generated block will look similar to this:

```
  rewrite ^/page-([0-9]+)$ /index.php?controller=blog&action=view&page=$1 last;

  if ($w3tc_rewrite = 1) {
    rewrite ^ "/wp-content/cache/page_enhanced/$host/$request_uri/_index$w3tc_ua$w3tc_ref$w3tc_ssl$w3tc_ext$w3tc_enc" last;
  }
```

#### server.location section

All available options can be seen under `_nginx_location` dict.

Controlled via `_nginx_user_settings.server.location` list.

See [server settings](#server-settings) for example.

The generated block will look similar to this:

```
  location ~ ^/index\.php(/|$) {
    set                     $path_info $fastcgi_path_info;
    include                 /etc/nginx/fastcgi_params;
    fastcgi_pass            127.0.0.1:9000;
    fastcgi_index           index.php;
    fastcgi_split_path_info ^(.+\.php)(/.*)$;
    fastcgi_param           SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param           APP_ENV dev;
    autoindex               on;
    try_files               $uri $uri/ /index.php$is_args$args;
  }
```

**`root`**

String

Default: `null`

**`index`**

String[]

Default:
```yaml
[
    - index.html
]
```

**`location`**

Used next to `location` keyword.

Example: `~ ^/index\.php(/|$)`

Required.

String

Default: `/`

**`alias`**

String

Default: `null`

**`allow`**

String[]

Default: `[]`

**`auth_basic`**

String

Default: `null`

**`auth_basic_user_file`**

String

Default: `null`

**`auth_request`**

String

Default: `null`

**`autoindex`**

String

Default: `'on'`

**`deny`**

String[]

Default: `[]`

**`expires`**

String

Default: `null`

**`fastcgi_index`**

String

Default: `null`

**`fastcgi_param`**

String[]

Default:
```yaml
[
    - SCRIPT_FILENAME $document_root$fastcgi_script_name
]
```

**`fastcgi_params_file`**

Used after `include` keyword.

example: `include /etc/nginx/fastcgi_params;`

String

Default: `{{ conf.conf_dir }}/fastcgi_params`

**`fastcgi_pass`**

String

Default: `null`

**`fastcgi_script`**

Only applicable if `fastcgi_pass` has string value.

Used after `fastcgi_param SCRIPT_FILENAME`.

example: `fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;`

String

Default: `null`

**`fastcgi_split_path_info`**

Only applicable if `fastcgi_pass` has string value.

String

Default: `null`

**`flv`**

Boolean

Default: `false`

**`include`**

String[]

Default: `[]`

**`internal`**

Boolean

Default: `false`

**`mp4`**

Boolean

Default: `false`

**`proxy_buffering`**

Only applicable if `proxy_pass` has string value.

String

Default: `null`

**`proxy_cache`**

Only applicable if `proxy_pass` has string value.

String

Default: `null`

**`proxy_cache_key`**

Only applicable if `proxy_pass` has string value.

String

Default: `null`

**`proxy_cache_use_stale`**

Only applicable if `proxy_pass` has string value.

String

Default: `null`

**`proxy_cache_valid`**

Only applicable if `proxy_pass` has string value.

String[]

Default: `[]`

**`proxy_connect_timeout`**

Only applicable if `proxy_pass` has string value.

String

Default: `60s`

**`proxy_hide_header`**

Only applicable if `proxy_pass` has string value.

String[]

Default: `[]`

**`proxy_http_version`**

Only applicable if `proxy_pass` has string value.

String

Default: `null`

**`proxy_method`**

Only applicable if `proxy_pass` has string value.

String

Default: `null`

**`proxy_pass`**

String

Default: `null`

**`proxy_pass_header`**

Only applicable if `proxy_pass` has string value.

String[]

Default: `[]`

**`proxy_read_timeout`**

Only applicable if `proxy_pass` has string value.

String

Default: `60s`

**`proxy_redirect`**

Only applicable if `proxy_pass` has string value.

String

Default: `null`

**`proxy_set_body`**

Only applicable if `proxy_pass` has string value.

String

Default: `null`

**`proxy_set_header`**

Only applicable if `proxy_pass` has string value.

String[]

Default: `[]`

**`satisfy`**

String

Default: `null`

**`set`**

String[]

Default: `[]`

**`stub_status`**

Boolean

Default: `false`

**`try_files`**

String[]

Default:
```yaml
[
    - $uri
    - $uri/
]
```

**`uwsgi_pass`**

String

Default: `null`

**`uwsgi_param`**

Only applicable if `uwsgi_pass` has string value.

String[]

Default: `[]`

**`uwsgi_params_file`**

Only applicable if `uwsgi_pass` has string value.

String

Default: `{{ conf.conf_dir }}/uwsgi_params`

**`uwsgi_read_timeout`**

Only applicable if `uwsgi_pass` has string value.

String

Default: `60s`

**`www_root`**

String

Default: `null`

**`rewrite`** (location.rewrite)

See _server.rewrite section_ for example.
